## ë§ˆì´ë°ì´í„° RAG-LLM Agent
`LangChain` `LangGraph` `OpenAI API`ë¥¼ í™œìš©í•˜ì—¬  ë§ˆì´ë°ì´í„° ê³µì‹ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •ì±…ê³¼ ê¸°ìˆ  ì‚¬ì–‘ ë“±ì„ ë‹µë³€í•  ìˆ˜ ìˆëŠ” ì±—ë´‡ RAG-LLM 
Agentì…ë‹ˆë‹¤.

---
## How to Run
- ğŸš¨ í”„ë¡œì íŠ¸ ì‹¤í–‰ì‹œ `5432` `6379` `8000` `8506` í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, í•´ë‹¹ í¬íŠ¸ê°€ ì‚¬ìš©ì¤‘ì´ë¼ë©´ ì‚¬ìš©ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•´ì£¼ì„¸ìš”
- ğŸš¨ ë°˜ë“œì‹œ OPENAI_API_KEYë¥¼ .env ì— ì„¤ì •í•˜ê³ ë‚œ ë‹¤ìŒ docker-composeë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤!
### 1. .env íŒŒì¼ì„ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ìƒì„±
```.dotenv
POSTGRES_HOST=pgvector
POSTGRES_PORT=5432

POSTGRES_DB=mydata-agent
POSTGRES_USER=mydata-agent-user
POSTGRES_PASSWORD=yhk-vqc_drq2GZK1rud

REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0

RETRIEVER_TOP_K=10
RETRIEVER_TOP_N=8

EMBEDDING_MODEL=text-embedding-3-large
CHAT_MODEL=gpt-4o

DOCUMENT_DIR=documents

OPENAI_API_KEY=<OPEN_API_KEYë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”>
```
### 2. Docker Composeë¥¼ í†µí•´ ëª¨ë‘ ì‹¤í–‰
```bash
docker-compose up -d
```

---
## ì„œë¹„ìŠ¤ í˜ì´ì§€ [127.0.0.1:8506 ìœ¼ë¡œ ì ‘ì†]
![image](documentation/streamlit.png)
- ì‚¬ìš©ìê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•˜ê³ , ì°¸ê³ í•œ ë¬¸ì„œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ë¬¸ì„œ í˜ì´ì§€ë¥¼ ìš”ì²­í•˜ë©´ í•´ë‹¹ í˜ì´ì§€ë¥¼ ì´ë¯¸ì§€ë¡œ ì œê³µí•©ë‹ˆë‹¤.

---
## ì•„í‚¤í…ì²˜
![image](documentation/architecture_overview.png)
### ê´€ë¦¬ì Usecase
1. ê´€ë¦¬ìëŠ” PDF íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
2. `RecursiveCharacterTextSplitter`ë¥¼ í†µí•´ PDFë¥¼ Chunkë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.
   - ì´í›„ ë™ì¼í•œ íŒŒì¼ì— ëŒ€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš°ë¥¼ ìœ„í•´ Pickle ë¡œì»¬ ìºì‹œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
   - ë§Œì•½ ë™ì¼í•œ íŒŒì¼ì— ëŒ€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš°, ìºì‹œëœ Chunkë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
3. OpenAI `text-embedding-3-large` ëª¨ë¸ì„ í™œìš©í•˜ì—¬ Chunkë¥¼ ë²¡í„°í™”í•©ë‹ˆë‹¤.
4. ë²¡í„°í™”ëœ Chunkë¥¼ `PGVector`ì— ì €ì¥í•©ë‹ˆë‹¤.

---
### ì‚¬ìš©ì Usecase
1. ì‚¬ìš©ìëŠ” `Streamlit` í˜ì´ì§€ë¥¼ í†µí•´ `ë§ˆì´ë°ì´í„°`ì— ëŒ€í•œ ì§ˆë¬¸ì„ ì…ë ¥í•©ë‹ˆë‹¤. ê°€ëŠ¥í•œ ì§ˆë¬¸ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
   - ë§ˆì´ë°ì´í„°ì— ëŒ€í•œ ì§ˆë¬¸
   - ë¬¸ì„œ í˜ì´ì§€ ìš”ì²­
   - History ê¸°ë°˜, ì´ì „ ì§ˆë¬¸ì— ëŒ€í•œ ì¶”ê°€ ì§ˆë¬¸
2. `Agent`ëŠ” ì‚¬ìš©ì ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬, Toolì´ í•„ìš”í•œì§€ ì¦‰ì‹œ ì‘ë‹µ ê°€ëŠ¥í•œì§€ íŒë‹¨í•©ë‹ˆë‹¤.
   - Toolì´ í•„ìš”í•œ ê²½ìš°: ëŒ€í™” Contextì— ë‹µë³€ì— í•„ìš”í•œ ë¬¸ì„œ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° / íŠ¹ì • í˜ì´ì§€ ì´ë¯¸ì§€ë¥¼ ìš”ì²­í•˜ëŠ” ê²½ìš°
   - ì¦‰ì‹œ ì‘ë‹µ ê°€ëŠ¥í•œ ê²½ìš°: ëŒ€í™” Contextì— ë‹µë³€ì— í•„ìš”í•œ ë¬¸ì„œ ì •ë³´ê°€ ìˆëŠ” ê²½ìš° / ì´ì „ ì§ˆë¬¸ì— ëŒ€í•œ ì¶”ê°€ ì§ˆë¬¸
3. `Tools`ëŠ” `Agent`ê°€ ê²°ì •í•œ Toolì„ ì‚¬ìš©í•˜ì—¬, ì¦‰ì‹œ ì‘ë‹µ ê°€ëŠ¥í•œ ê²½ìš°ì— ëŒ€í•œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
   - ì‚¬ìš©ê°€ëŠ¥í•œ Toolì€ `Retriever`, `ë¬¸ì„œê²€ìƒ‰ê¸°`ê°€ ìˆìŠµë‹ˆë‹¤.
     - `Retriever`: `PGVector`ì— ì €ì¥ëœ ë²¡í„°ì™€ ì‚¬ìš©ì ì§ˆë¬¸ ë²¡í„°ë¥¼ ë¹„êµí•˜ì—¬, ê°€ì¥ ìœ ì‚¬í•œ Chunkë¥¼ ì°¾ìŠµë‹ˆë‹¤.
     - `ë¬¸ì„œê²€ìƒ‰ê¸°`: ì‚¬ìš©ìê°€ ìš”ì²­í•œ ë¬¸ì„œì˜ íŠ¹ì • í˜ì´ì§€ ì´ë¯¸ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
4. `Agent`ëŠ” ì§ì ‘ ìƒì„±í•˜ê±°ë‚˜, `Tools`ë¡œë¶€í„° ë°›ì€ ë‹µë³€ì„ ì‚¬ìš©ìì—ê²Œ ì œê³µí•©ë‹ˆë‹¤.

---
## í”„ë¡œì íŠ¸ í´ë” êµ¬ì¡°
```text
â”œâ”€â”€ api
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ main.py .................... ğŸš€ FastAPI ì„œë²„ ì§„ì…ì 
â”‚Â Â  â”œâ”€â”€ admin ...................... ğŸ“Œ RAGì— ì‚¬ìš©í•  íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ì„œë¹„ìŠ¤ 
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ router.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ service.py
â”‚Â Â  â”œâ”€â”€ agent ...................... ğŸ“Œ RAG-LLMì„ í™œìš©í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì„œë¹„ìŠ¤
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ router.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ schema.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ service.py ............. â­ï¸ LangGraphë¥¼ í†µí•´ Agentêµ¬ì„± ë° ë‹µë³€ ìƒì„±
â”‚Â Â  â”‚Â Â  â””â”€â”€ tools.py ............... ğŸ”§ AGENTê°€ ì‚¬ìš©í•  Tool í•¨ìˆ˜ë“¤
â”‚Â Â  â”œâ”€â”€ documents
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ì˜ˆì œíŒŒì¼1.pdf 
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ì˜ˆì œíŒŒì¼2.pdf 
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ í…ŒìŠ¤íŠ¸.pdf
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ page_chunk ............. ğŸ“ "@@ë¬¸ì„œ @í˜ì´ì§€ ë³´ì—¬ì¤˜" ìš”ì²­ì— ëŒ€í•œ PDF ì´ë¯¸ì§€ ì €ì¥ì†Œ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pickle ................. ğŸ¥’ ì—¬ëŸ¬ë²ˆì˜ ì„œë²„ ì‹¤í–‰ì—ë„, ìºì‹±ëœ FileChunkë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì €ì¥ì†Œ
â”‚Â Â  â”œâ”€â”€ prompt
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ prompt.yml ............. ğŸ“ LangChain ë° MultiQuery Retrieverì— ì‚¬ìš©í•  Prompt
â”‚Â Â  â”œâ”€â”€ util ....................... ğŸ›  API ì„œë¹„ìŠ¤ì— ì‚¬ìš©í•  ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ chain_builder.py ....... ğŸ“œ ë™ì  Chain êµ¬ì„±ì„ ìœ„í•œ í•¨ìˆ˜
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ config.py .............. ğŸ“¦ í™˜ê²½ë³€ìˆ˜ (w/ Pydantic Settings)
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ custom_wrapper ......... ğŸ API ì„œë¹„ìŠ¤ì— ì‚¬ìš©í•  ì»¤ìŠ¤í…€ ë˜í¼ (Dictì…ë ¥ ëŒ€ì‘ ë“±)
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dependency.py .......... ğŸ“¦ VectorStore, ChatOpenAI ë“±ì˜ ì˜ì¡´ì„± ì •ì˜
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ processor.py ........... ğŸ§¹ Chain ì…ë ¥ì„ ì •ê·œí™”í•˜ëŠ” í•¨ìˆ˜
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ splitter.py ............ ğŸª“ RAGêµ¬ì„±ì„ ìœ„í•´ PDFë¥¼ Chunkë¡œ ë‚˜ëˆ„ëŠ” í•¨ìˆ˜
â”‚Â Â  â”‚Â Â  â””â”€â”€ utils.py ............... ğŸ›  Singletone ë°ì½”ë ˆì´í„° ë“± ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚Â Â  â””â”€â”€ test ....................... ğŸ§ª API í…ŒìŠ¤íŠ¸(noqa)
â”‚Â Â      â”œâ”€â”€ __init__.py
â”‚Â Â      â”œâ”€â”€ admin
â”‚Â Â      â”œâ”€â”€ agent
â”‚Â Â      â””â”€â”€ util
â”œâ”€â”€ client .......................... ğŸŒ Streamlit í´ë¼ì´ì–¸íŠ¸
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ app.py ...................... ğŸš€ Streamlit ì„œë²„ ì§„ì…ì 
â”‚Â Â  â””â”€â”€ assets
â”‚Â Â      â”œâ”€â”€ favicon.png
â”‚Â Â      â””â”€â”€ profile
â”œâ”€â”€ docker .......................... ğŸ³ Docker ë¡œì»¬ ë³¼ë¥¨
â”‚Â Â  â””â”€â”€ pgvector
â”‚Â Â      â”œâ”€â”€ data
â”‚Â Â      â””â”€â”€ init.sql
â”œâ”€â”€ docker-compose.yml .............. ğŸ³ Docker Compose ì„¤ì •
â”œâ”€â”€ poetry.lock
â””â”€â”€ pyproject.toml

```
---
## Key Features & Tools
### â­ Agent ì£¼ë„í˜• ì±—ë´‡
> í‚¤ì›Œë“œ: `LangGraph` `LangChain` `Tool Bind`

LangChainì—ì„œ ì •ì˜í•˜ëŠ” AgentëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

> ì—ì´ì „íŠ¸ì˜ í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ì–¸ì–´ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì·¨í•  ì¼ë ¨ì˜ í–‰ë™ì„ ì„ íƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì²´ì¸ì—ì„œ ì¼ë ¨ì˜ í–‰ë™ì€ í•˜ë“œì½”ë”©ë©ë‹ˆë‹¤(ì½”ë“œë¡œ). ì—ì´ì „íŠ¸ì—ì„œ ì–¸ì–´ ëª¨ë¸ì€ ì–´ë–¤ 
> í–‰ë™ì„ ì–´ë–¤ ìˆœì„œë¡œ ì·¨í• ì§€ ê²°ì •í•˜ëŠ” ì¶”ë¡  ì—”ì§„ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ Agent ì£¼ë„í˜• ì±—ë´‡ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´, Agentê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Toolì„ ì •ì˜í•˜ê³ , Agentê°€ Toolì„ ì‚¬ìš©í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

![image](documentation/langgraph.png)
ìœ„ì˜ ì´ë¯¸ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë“¯, AgentëŠ” [ì¦‰ì‹œ ë‹µë³€]í•˜ê±°ë‚˜, [Toolì„ ì‚¬ìš©]í•˜ëŠ” ì„ íƒì„ í•©ë‹ˆë‹¤.
- Toolì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, AgentëŠ” ì‚¬ìš©í•  Toolì„ ì„ íƒí•˜ê³ , Toolì´ ë‹µë³€ì„ ìƒì„±í•˜ë„ë¡ í•©ë‹ˆë‹¤.
- ì¦‰ì‹œ ë‹µë³€í•˜ëŠ” ê²½ìš°, Agentê°€ ê°€ì§€ê³ ìˆëŠ” LLM ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.

ì‚¬ìš©ê°€ëŠ¥í•œ Toolì€ `Retriever`, `ë¬¸ì„œê²€ìƒ‰ê¸°`ê°€ ìˆìŠµë‹ˆë‹¤.
- `Retriever`: `PGVector`ì— ì €ì¥ëœ ë²¡í„°ì™€ ì‚¬ìš©ì ì§ˆë¬¸ ë²¡í„°ë¥¼ ë¹„êµí•˜ì—¬, ê°€ì¥ ìœ ì‚¬í•œ Chunkë¥¼ ì°¾ìŠµë‹ˆë‹¤.
- `ë¬¸ì„œê²€ìƒ‰ê¸°`: ì‚¬ìš©ìê°€ ìš”ì²­í•œ ë¬¸ì„œì˜ íŠ¹ì • í˜ì´ì§€ ì´ë¯¸ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

```python
self.tool_set = [
    StructuredTool.from_function(
        func=rag(self.retriever),
        name="mydata-retriever",
        description="ê¸ˆìœµë¶„ì•¼ ë§ˆì´ë°ì´í„° í‘œì¤€ API ê·œê²©ê³¼ ê¸ˆìœµë¶„ì•¼ ë§ˆì´ë°ì´í„° ê¸°ìˆ  ê°€ì´ë“œë¼ì¸ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. 'API ìŠ¤í™ ì¤‘ aNSëŠ” ì–´ë–¤ ê²ƒì„ "
        "ëœ»í•˜ë‚˜ìš”?'ê°™ì€ ì§ˆë¬¸ì— ì´ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.",
        args_schema=RAGInput,
    ),
    ...
]
```
ToolBindëŠ” ë³µì¡í•œ Chainêµ¬ì„±ì„ ìš”êµ¬í•˜ì§€ ì•Šê³ , ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨í•œ í•¨ìˆ˜ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤. AgentëŠ” descriptionì„ ì°¸ê³ í•˜ì—¬, ê°€ì¥ 
ì ì ˆí•œ Toolì„ ì„ íƒí•˜ì—¬ ë™ì‘í•©ë‹ˆë‹¤.

---
### â­ ë¬¸ì„œ í˜ì´ì§€ ì´ë¯¸ì§€ ì œê³µ
> í‚¤ì›Œë“œ: `ë¬¸ì„œ ì´ë¯¸ì§€ ì œê³µ`

![image](documentation/image_retrieve.png)
ì•ì„œ ì–¸ê¸‰í•œ Tool ì¤‘ í•˜ë‚˜ë¡œ, `ë¬¸ì„œê²€ìƒ‰ê¸°`ë¥¼ ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤. ì´ Toolì„ í†µí•´, "APIë¬¸ì„œ 30í˜ì´ì§€ ë³´ì—¬ì¤˜"ì™€ ê°™ì€ ìš”ì²­ì— ëŒ€í•´, í•´ë‹¹ í˜ì´ì§€ì˜ ì´ë¯¸ì§€ë¥¼ ì œê³µí•  
ìˆ˜ ìˆë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
- ì´ë¯¸ì§€ë¥¼ Base64 ê·¸ëŒ€ë¡œ ì‘ë‹µí•˜ëŠ”ê²ƒì€ Contextë¥¼ í¬ê²Œ ì°¨ì§€í•˜ê²Œ ë˜ë¯€ë¡œ, ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ê³ , í•´ë‹¹ ì´ë¯¸ì§€ì˜ URLì„ ì‘ë‹µí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

---
### â­ ë‹µë³€ìƒì„± ì§„í–‰ìƒí™© ì œê³µ
> í‚¤ì›Œë“œ: `ì§„í–‰ìƒí™© ì œê³µ` `UX ê°œì„ `
 
ì±—ë´‡ ì„œë¹„ìŠ¤ëŠ” LLM ì¶”ë¡ ì„œë²„ í˜¹ì€ API ì„œë²„ì˜ ìƒíƒœì— ë”°ë¼ ì‘ë‹µì´ ëŠ¦ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ ì™¸ì—ë„, ì—¬ëŸ¬ Toolì„ ì‚¬ìš©í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ê²½ìš°ì—ë„ ë‹µë³€ì´ ëŠ¦ì–´ì§ˆ ìˆ˜ 
ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ìƒí™©ì— ì‚¬ìš©ìì—ê²Œ ë‹µë³€ì´ ìƒì„±ì¤‘ì„ì„ ì•Œë ¤ì£¼ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

![image](documentation/waiting.png)
ë‹µë³€ ìƒì„±ì´ ì‹œì‘ë˜ë©´ ìœ„ì™€ ê°™ì´, ì‚¬ìš©ìì—ê²Œ ë‹µë³€ ìƒì„±ì¤‘ì„ì„ ì•Œë ¤ì£¼ëŠ” ë©”ì‹œì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

![image](documentation/done.png)
Tool ì‚¬ìš© ë“±, ë‹µë³€ ìƒì„± í”„ë¡œì„¸ìŠ¤ê°€ ì§„í–‰ë¨ì— ë”°ë¼ ìœ„ì™€ê°™ì´ ë‹¨ê³„ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

---
### â­ ì •í™•í•œ ë‹µë³€ ìƒì„±ì„ ìœ„í•œ Retriever êµ¬ì¡°
> í‚¤ì›Œë“œ: `PGVector` `BM25` `Reranker` `MultiQuery`
 
RetrieverëŠ” ì§ˆë¬¸ì— ë”°ë¼, ì–´ë–¤ ë¬¸ì„œê°€ ê°€ì¥ ì ì ˆí•œ ë¬¸ì„œì¸ì§€ íŒë‹¨í•˜ì—¬ ë‹µë³€ì„ ê°€ì ¸ì˜¤ê²Œ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì§ˆë¬¸ì˜ ì¢…ë¥˜ì— ë”°ë¼, `Lexical Similarity`ê°€ 
ë†’ì€ ë¬¸ì„œê°€ ì ì ˆí•  ìˆ˜ë„ ìˆê³ , `Semantic Similarity`ê°€ ë†’ì€ ë¬¸ì„œê°€ ì ì ˆí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´, `BM25`ì™€ `Reranker`ë¥¼ 
`EnsembleRetriever`ë¡œ ê²°í•©í•œ ë’¤, `FlashRank Reranker`ë¥¼ í†µí•´ ìµœì¢…ì ìœ¼ë¡œ ê°€ì¥ ì ì ˆí•œ ë¬¸ì„œë¥¼ ì„ íƒí•˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

---
### ë©€í‹°í„´ ì—ì´ì „íŠ¸
> í‚¤ì›Œë“œ: `AsyncRedisSaver` `checkpointer`

ë©€í‹°í„´ ì—ì´ì „íŠ¸ëŠ” ì‚¬ìš©ìê°€ ì´ì „ ì§ˆë¬¸ì— ëŒ€í•œ ì¶”ê°€ ì§ˆë¬¸ì„ í•˜ëŠ” ê²½ìš°, ì´ì „ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì°¸ì¡°í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´, `AsyncRedisSaver`ë¥¼ 
ì ìš©í•˜ì—¬ ì´ì „ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì €ì¥í•˜ê³ , `checkpointer`ë¥¼ í†µí•´ ì´ì „ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

---
### í™•ì¥ ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸ êµ¬ì¡°
> í‚¤ì›Œë“œ: `ë™ì  Chain Builder` `Pydantic Schema` `Dependency Injection`

LLM ì±—ë´‡ ì„œë¹„ìŠ¤ëŠ” ë§ì€ ì‚¬ìš©ìë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ê¸°ì—, ìš”ì²­ì‹œë§ˆë‹¤ ì–´ë–¤ ì„œë¹„ìŠ¤ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ”ê²ƒì€ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´, `Dependency Injection`ì„ 
í†µí•´, Singletonìœ¼ë¡œ ìƒì„±ëœ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
```python
# ì‹±ê¸€í†¤ ê°ì²´
@singleton
class RetrieverFactory:
    """PGVector, LLM, BM25Retrieverë¥¼ ì‚¬ìš©í•˜ì—¬ ContextualCompressionRetriever ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” í´ë˜ìŠ¤"""

    def __init__(self, config: AppConfig = get_app_config()):
        self.config = config

# ì˜ì¡´ì„± ì£¼ì… ì˜ˆì‹œ
class AgentService:
    def __init__(
        self,
        config: AppConfig = Depends(get_app_config),
        llm: ChatOpenAI = Depends(LLM()),
        retriever: ContextualCompressionRetriever = Depends(RetrieverFactory()),
    ):
        ...
```

LLM ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ë©° Chainì„ ë°˜ë³µí•˜ì—¬ ì‘ì„±í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ê²½ìš°ì—ë„, ë³´ë‹¤ ì ì€ ì½”ë“œëŸ‰ìœ¼ë¡œ Chainì„ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡, ë™ì  Chain 
Builderë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ì¼ë¡€ë¡œ, Output Parserë¥¼ ë¬¸ìì—´ íŒŒë¼ë¯¸í„°ë¡œ ì„ íƒí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ë˜í•œ êµ¬í˜„í–ˆëŠ”ë°, ì•„ë˜ì™€ ê°™ì´ ê°„ê²°í•œ ì‚¬ìš©ë²•ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```python
# êµ¬í˜„
class ChainBuilder:
    ...
    def _output_parser(output_parser: str):
        """output_parser_typeì— ë”°ë¼, í•´ë‹¹í•˜ëŠ” OutputParserë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
        match output_parser:
            case "str":
                return StrOutputParser()
            case "json":
                return JsonOutputParser()
            case "agent":
                return OpenAIToolsAgentOutputParser()
            case _:
                raise ValueError(
                    f"ì§€ì›í•˜ì§€ ì•ŠëŠ” output_parser_typeì…ë‹ˆë‹¤. ({output_parser})"
                )


# ì‚¬ìš© ì˜ˆì‹œ
chain_builder.build_chain(
    ...,
    llm=self.llm,
    output_parser="agent",
)
``` 

---
### ì‚¬ìš©ìë³„ ìš”ì²­ì— ëŒ€í•œ ë™ì‹œì„± í•´ê²°
> í‚¤ì›Œë“œ: `Session ID`

ì±—ë´‡ ì„œë¹„ìŠ¤ëŠ” ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ê²½ìš°, ì‚¬ìš©ìë³„ë¡œ ìš”ì²­ì„ êµ¬ë¶„í•˜ì—¬, ì‚¬ìš©ìë³„ë¡œ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ 
ìœ„í•´, ì²« ìš”ì²­ì—ì„œ ì‚¬ìš©ìë§ˆë‹¤ ê³ ìœ í•œ `Session ID`ë¥¼ ìƒì„±í•˜ê³ , ì´í›„ ìš”ì²­ì—ì„œëŠ” ì´ `Session ID`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

```python
    async def generate_answer(self, *, question: UserQuerySchema):
        """ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.

        1. Agent LangGraphë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        2. ì„¸ì…˜ IDê°€ ì—†ëŠ” ê²½ìš° ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
        3. Agent LangGraphë¥¼ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        """
        ...
        # ì„¸ì…˜ ID ìƒì„±
        new_session_id = str(uuid4().hex)
        ...
        # session IDë¡œ Historyë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ì„¤ì •
        async for event in agent_graph.astream(
            {"messages": ("user", question.query)},
            {
                "configurable": {
                    "thread_id": (question.session_id or new_session_id)
                }
            },
        ):
            ...
            # ì‘ë‹µ ë°ì´í„°ì— ì„¸ì…˜ ID ì¶”ê°€
            yield f"data: {json.dumps(session_field | type_field | content)}\n\n"
``` 

---
### ëª¨ë¸ í† í° ì œí•œ í•´ê²°
> í‚¤ì›Œë“œ: `history` `AsyncRedisSaver`

ëª¨ë¸ì€ í† í° ì œí•œì—ëŠ” í¬ê²Œ ë‘ê°€ì§€ ì¢…ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.
- `Max Tokens`: í•œë²ˆì— ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í† í° ìˆ˜
- `TPM`: ë¶„ë‹¹ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” í† í° ìˆ˜

`TPM`ëŠ” ë¶„ë‹¹ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” í† í° ìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ì—ì„œëŠ” `Completion` ë˜ëŠ” `MultiQuery`ì—ì„œ OpenAI APIë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. 
ê·¸ ì¤‘, `AsyncRedisSaver`ë¥¼ ì‚¬ìš©í•˜ì—¬, ê¸°ì¡´ì— Retrieveí•œ ë¬¸ì„œë¥¼ Contextì— ë“¤ê³  ìˆë‹¤ë©´, `MultiQuery`ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šë„ë¡ í•˜ì—¬ 
`TPM`ì„ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.


`MAX Tokens`ëŠ” í•œë²ˆì— ë„ˆë¬´ ë§ì€ Historyë¥¼ í¬í•¨í•˜ê±°ë‚˜ ê¸´ ë¬¸ì¥ì„ ì²˜ë¦¬í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, `tiktoken`ì„ ì‚¬ìš©í•˜ëŠ” 
`_filter_message_by_token_length` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬, ìš”ì²­ì„ ë³´ë‚´ê¸° ì „ ìµœëŒ€ í† í° ì´ë‚´ë¡œ Historyë¥¼ í•„í„°ë§í•˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
```python
async def _filter_message_by_token_length(messages):
    # ë©”ì‹œì§€ë¥¼ ìµœê·¼ê²ƒë¶€í„° ìˆœíšŒí•˜ë©´ì„œ, í† í° ê¸¸ì´ ì´ í•©ì´ 1000ì„ ë„˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
    filtered_messages = []
    token_length = 0
    for message in reversed(messages):
        token_length += await _get_token_length(message.content)
        if token_length > 3072:
            break
        filtered_messages.append(message)

    return list(reversed(filtered_messages))
```





